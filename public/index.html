<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Include chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js" integrity="sha512-Wt1bJGtlnMtGP0dqNFH1xlkLBNpEodaiQ8ZN5JLA5wpc1sUlk/O5uuOMNgvzddzkpvZ9GLyYNa8w2s7rqiTk5Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        var options_hr = {
            responsive: true,
            //maintainAspectRatio: false,
            aspectRatio: .75,
            plugins: {
                legend: {
                    display: false,
                }
            },
            scales: {
                y: {
                    min: 0,
                    suggestedMax: 6,
                    grid: {
                        color: function(context) {
                            if (context.tick.value == 4) {
                                return "rgba(0, 0, 0, 1)";
                            } else if (context.tick.value > 4) {
                                return "rgba(103, 221, 0, 1)";
                            } else if (context.tick.value < 4) {
                                return "rgba(221, 0, 103, 1)";
                            }
                        }
                    }
                }
            }
        };
        var options_temp = {
            responsive: true,
            plugins: {
                legend: {
                    display: false,
                }
            },
            //maintainAspectRatio: false,
            aspectRatio: .75,
        };

        var options_fans = {
            aspectRatio: 1.5,
            events: [],
            responsive: true,
            plugins: {
                legend: {
                    display: false,
                }
            }
        };
    </script>
    <!-- Include JQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <!-- Include Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.min.js" integrity="sha384-cn7l7gDp0eyniUwwAZgrzD06kc/tftFf19TOAs2zVinnD/C7E91j9yyk5//jjpt/" crossorigin="anonymous"></script>
    <!-- Include socketIO -->
    <script src="https://cdn.socket.io/4.1.2/socket.io.min.js" integrity="sha384-toS6mmwu70G0fw54EGlWWeA4z3dyJ+dlXBtSURSKN4vyRFOcxd3Bzjj/AoOwY+Rg" crossorigin="anonymous"></script>
    <!-- Include local JS client -->
    <script src="/index.js"></script>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <div class="py-2">
        <div class="container">
            <div id="chart_container" class="row row-cols-1 row-cols-sm-2 row-cols-md-3">
                <script>
                    function generate_graphs(data_graph) {
                        container_all = document.getElementById('chart_container')
                        container_all.innerHTML = ""
                        data_graph.miners.forEach(function(miner) {


                            var fan_rpm_1 = miner.Fans.fan_0.RPM;
                            var fan_rpm_2 = miner.Fans.fan_1.RPM;
                            var hr_canvas = document.createElement('canvas');
                            var temp_canvas = document.createElement('canvas');
                            var fan_1_title = document.createElement('p');
                            var fan_2_title = document.createElement('p');
                            fan_1_title.innerHTML += "Fan 1: " + fan_rpm_1 + " RPM";
                            fan_1_title.className = "text-center"
                            fan_2_title.innerHTML += "Fan 2: " + fan_rpm_2 + " RPM";
                            fan_2_title.className = "text-center"
                            var fan_1_canvas = document.createElement('canvas');
                            var fan_2_canvas = document.createElement('canvas');
                            var column = document.createElement('div');
                            column.className = "col border border-dark p-3"
                            var row_1 = document.createElement('div');
                            row_1.className = "row"
                            var row_fan_title = document.createElement('div');
                            row_fan_title.className = "row"
                            var row_2 = document.createElement('div');
                            row_2.className = "row"
                            var container_col_hr = document.createElement('div');
                            var container_col_temp = document.createElement('div');
                            var container_col_title_fan_1 = document.createElement('div');
                            var container_col_title_fan_2 = document.createElement('div');
                            var container_col_fan_1 = document.createElement('div');
                            var container_col_fan_2 = document.createElement('div');
                            container_col_hr.className = "col w-50 ps-0 pe-4"
                            container_col_temp.className = "col w-50 ps-0 pe-4"
                            container_col_title_fan_1.className = "col"
                            container_col_title_fan_2.className = "col"
                            container_col_fan_1.className = "col w-50 ps-3 pe-1"
                            container_col_fan_2.className = "col w-50 ps-3 pe-1"


                            container_col_hr.append(hr_canvas)
                            container_col_temp.append(temp_canvas)
                            container_col_title_fan_1.append(fan_1_title)
                            container_col_title_fan_2.append(fan_2_title)
                            container_col_fan_1.append(fan_1_canvas)
                            container_col_fan_2.append(fan_2_canvas)


                            var header = document.createElement('h3');
                            header.className = "text-center"
                            header.innerHTML += miner.IP
                            column.append(header)



                            row_1.append(container_col_hr)
                            row_1.append(container_col_temp)
                            column.append(row_1)

                            row_fan_title.append(container_col_title_fan_1)
                            row_fan_title.append(container_col_title_fan_2)
                            column.append(row_fan_title)

                            row_2.append(container_col_fan_1)
                            row_2.append(container_col_fan_2)
                            column.append(row_2)

                            container_all.append(column);

                            var hr_data = []
                            for (const board_num of [6, 7, 8]) {
                                if (("board_" + board_num) in miner.HR) {
                                    key = "board_"+board_num
                                    hr_data.push({label: board_num, data: [miner.HR[key].HR], backgroundColor: []})
                                    if (board_num == 6) {
                                        hr_data[0].backgroundColor = ["rgba(12, 58, 242, 1)"]
                                    } else if (board_num == 7) {
                                        hr_data[0].backgroundColor = ["rgba(0, 84, 219, 1)"]
                                    } else if (board_num == 8) {
                                        hr_data[0].backgroundColor = ["rgba(0, 139, 245, 1)"]
                                    }
                                }
                            }

                            var chart_hr = new Chart(hr_canvas, {
                                type: "bar",
                                data: {
                                    labels: ["Hashrate"],
                                    datasets: hr_data
                                },
                                options: options_hr
                            });


                            var temps_data = []
                            for (const board_num of [6, 7, 8]) {
                                if (("board_" + board_num) in miner.Temps) {
                                    key = "board_"+board_num
                                    temps_data.push({label: board_num + "Chip", data: [miner.Temps[key].Chip], backgroundColor: ["rgba(6, 92, 39, 1)"]});
                                    temps_data.push({label: board_num + "Board", data: [miner.Temps[key].Board], backgroundColor: ["rgba(255, 15, 58, 1)"]});
                                }
                            }


                            var chart_temp = new Chart(temp_canvas, {
                                type: "bar",
                                data: {
                                    labels: ["Temps"],
                                    datasets: temps_data
                                },
                                options: options_temp,
                            });



                            var fan_data_1 = [fan_rpm_1, (6000-fan_rpm_1)];

                            var chart_fan_1 = new Chart(fan_1_canvas, {
                                type: "doughnut",
                                data: {
                                    labels: ["Fan 1"],
                                    datasets: [
                                        {
                                            data: fan_data_1,
                                            backgroundColor: [
                                                "rgba(103, 0, 221, 1)",
                                                "rgba(255, 255, 255, 1)"
                                            ]
                                        },
                                    ]
                                },
                                options: options_fans
                            });


                            var fan_data_2 = [fan_rpm_2, (6000-fan_rpm_2)];
                            var chart_fan_2 = new Chart(fan_2_canvas, {
                                type: "doughnut",
                                data: {
                                    labels: ["Fan 2"],
                                    datasets: [
                                        {
                                            data: fan_data_2,
                                            backgroundColor: [
                                                "rgba(103, 0, 221, 1)",
                                                "rgba(255, 255, 255, 1)"
                                            ]
                                        },
                                    ]
                                },
                                options: options_fans
                            });
                        });
                    }
                    const sio = io();

                    sio.on("miner_data", (data, cb) => {
                        console.log(data)
                        generate_graphs(JSON.parse(data));
                        cb("graph data received");
                    });
                </script>
            </div>
        </div>
    </div>
</body>
</html>